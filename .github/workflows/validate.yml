name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run smoke tests
        run: |
          chmod +x tests/smoke-test.sh
          ./tests/smoke-test.sh --verbose

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          echo "=== Running ShellCheck ==="
          find . -name "*.sh" -type f \
            -not -path "./.git/*" \
            -print0 | xargs -0 -r shellcheck --severity=error || {
              echo "ShellCheck found errors"
              exit 1
            }
          echo "✅ ShellCheck passed"

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for secrets
        run: |
          echo "=== Scanning for secrets ==="
          # Common secret patterns
          patterns=(
            "password.*=.*['\"][^'\"]{8,}['\"]"
            "api[_-]?key.*=.*['\"][^'\"]{16,}['\"]"
            "secret.*=.*['\"][^'\"]{8,}['\"]"
            "token.*=.*['\"][^'\"]{16,}['\"]"
            "AWS[_A-Z]*=.*['\"][A-Z0-9]{16,}['\"]"
          )

          found=0
          for pattern in "${patterns[@]}"; do
            if grep -r -i -E "$pattern" \
                --exclude-dir=.git \
                --exclude-dir=tests \
                --exclude="*.md" \
                --exclude="validate.yml" \
                . 2>/dev/null; then
              found=1
            fi
          done

          if [[ $found -eq 1 ]]; then
            echo "⚠️ Potential secrets found - review above"
            exit 1
          fi
          echo "✅ No secrets detected"

      - name: Check for dangerous patterns
        run: |
          echo "=== Checking for dangerous patterns ==="
          # Patterns that could be dangerous in scripts
          # Note: validate.sh files use eval safely for CLI validation
          dangerous=(
            "rm -rf /"
            "curl.*\| *sh"
            "curl.*\| *bash"
            "wget.*\| *sh"
          )

          found=0
          for pattern in "${dangerous[@]}"; do
            if grep -r -E "$pattern" \
                --include="*.sh" \
                --exclude-dir=.git \
                . 2>/dev/null; then
              echo "Found: $pattern"
              found=1
            fi
          done

          if [[ $found -eq 1 ]]; then
            echo "⚠️ Dangerous patterns found"
            exit 1
          fi
          echo "✅ No dangerous patterns"

  plugin-load-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate plugin manifests
        run: |
          echo "=== Validating plugin.json manifests ==="

          # Valid keys per Claude Code plugin spec
          valid_keys='["name","version","description","author","homepage","repository","license","keywords","commands","skills","agents"]'

          failed=0
          for manifest in plugins/*/.claude-plugin/plugin.json .claude-plugin/plugin.json; do
            [[ ! -f "$manifest" ]] && continue
            plugin=$(dirname "$(dirname "$manifest")")
            name=$(basename "$plugin")
            [[ "$name" == "." ]] && name="root"

            # Check for invalid keys (like $schema, strict)
            invalid=$(jq -r --argjson valid "$valid_keys" 'keys - $valid | .[]' "$manifest" 2>/dev/null)
            if [[ -n "$invalid" ]]; then
              echo "❌ $name: invalid keys in manifest: $invalid"
              failed=1
            fi

            # Check required fields
            if ! jq -e '.name' "$manifest" > /dev/null 2>&1; then
              echo "❌ $name: missing 'name' field"
              failed=1
            fi
            if ! jq -e '.version' "$manifest" > /dev/null 2>&1; then
              echo "❌ $name: missing 'version' field"
              failed=1
            fi
          done

          [[ $failed -eq 1 ]] && exit 1
          echo "✅ All manifests valid"

      - name: Check for broken symlinks
        run: |
          echo "=== Checking for symlinks ==="

          # Symlinks break when plugins installed standalone from GitHub
          symlinks=$(find plugins -type l 2>/dev/null)
          if [[ -n "$symlinks" ]]; then
            echo "❌ Found symlinks that will break standalone installation:"
            echo "$symlinks"
            echo ""
            echo "Replace symlinks with actual files for standalone plugin compatibility."
            exit 1
          fi

          echo "✅ No symlinks found"

      - name: Test plugin directory structure
        run: |
          echo "=== Testing plugin load compatibility ==="

          for plugin in plugins/*/; do
            name=$(basename "$plugin")
            echo "Testing $name..."

            # Check .claude-plugin/plugin.json exists and is valid JSON
            manifest="${plugin}.claude-plugin/plugin.json"
            if [[ ! -f "$manifest" ]]; then
              echo "❌ $name: missing .claude-plugin/plugin.json"
              exit 1
            fi

            if ! jq empty "$manifest" 2>/dev/null; then
              echo "❌ $name: invalid JSON in plugin.json"
              exit 1
            fi

            # Check skills directory
            if [[ -d "${plugin}skills" ]]; then
              skill_count=0
              for skill in "${plugin}skills"/*/; do
                [[ ! -d "$skill" ]] && continue
                skill_name=$(basename "$skill")

                # Each skill must have SKILL.md
                if [[ ! -f "${skill}SKILL.md" ]]; then
                  echo "❌ $name: $skill_name missing SKILL.md"
                  exit 1
                fi

                # SKILL.md must have YAML frontmatter with name field
                if ! head -1 "${skill}SKILL.md" | grep -q "^---$"; then
                  echo "❌ $name: $skill_name SKILL.md missing YAML frontmatter"
                  exit 1
                fi

                if ! grep -q "^name:" "${skill}SKILL.md"; then
                  echo "❌ $name: $skill_name SKILL.md missing 'name' in frontmatter"
                  exit 1
                fi

                skill_count=$((skill_count + 1))
              done
              echo "  ✓ $skill_count skills"
            fi

            echo "✅ $name"
          done

          echo ""
          echo "✅ All plugins have valid structure"

  e2e-install-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run E2E install test
        run: |
          chmod +x tests/e2e-install-test.sh
          ./tests/e2e-install-test.sh

  summary:
    needs: [smoke-test, shellcheck, security-scan, plugin-load-test, e2e-install-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "=== CI Summary ==="
          echo "smoke-test: ${{ needs.smoke-test.result }}"
          echo "shellcheck: ${{ needs.shellcheck.result }}"
          echo "security-scan: ${{ needs.security-scan.result }}"
          echo "plugin-load-test: ${{ needs.plugin-load-test.result }}"
          echo "e2e-install-test: ${{ needs.e2e-install-test.result }}"

          if [[ "${{ needs.smoke-test.result }}" != "success" ]] || \
             [[ "${{ needs.shellcheck.result }}" != "success" ]] || \
             [[ "${{ needs.security-scan.result }}" != "success" ]] || \
             [[ "${{ needs.plugin-load-test.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-install-test.result }}" != "success" ]]; then
            echo ""
            echo "❌ Some checks failed"
            exit 1
          fi

          echo ""
          echo "✅ All checks passed"
