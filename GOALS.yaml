version: 1
mission: "DevOps for AI agents — automates context, validation, execution, and learning"

goals:
  # === Critical (weight 5) — Build & test integrity ===

  - id: go-cli-builds
    description: "Go CLI compiles without errors"
    check: "cd cli && go build -o /tmp/test-ao ./cmd/ao >/dev/null 2>&1"
    weight: 5

  - id: go-cli-tests
    description: "Go CLI unit tests pass"
    check: "cd cli && go test ./... >/dev/null 2>&1"
    weight: 5

  # === Important (weight 3-4) — Suite & safety ===

  - id: full-test-suite
    description: "Full test suite passes (all tiers)"
    check: "./tests/run-all.sh"
    weight: 4

  - id: hook-preflight
    description: "All hooks pass safety checks (kill switches, paths)"
    check: "./scripts/validate-hook-preflight.sh >/dev/null 2>&1"
    weight: 4

  - id: smoke-tests
    description: "Smoke tests pass (toolchain, skills, manifests)"
    check: "./tests/smoke-test.sh"
    weight: 3

  - id: go-vet-clean
    description: "Go CLI passes vet checks (no common bugs)"
    check: "cd cli && go vet ./... 2>&1"
    weight: 3

  - id: manifest-versions-match
    description: "Plugin and marketplace versions are in sync"
    check: "test \"$(jq -r '.metadata.version' .claude-plugin/marketplace.json)\" = \"$(jq -r '.version' .claude-plugin/plugin.json)\""
    weight: 3

  - id: go-race-clean
    description: "Go CLI passes race detector (no data races)"
    check: "cd cli && go test -race ./... >/dev/null 2>&1"
    weight: 3

  # === Mission fitness (weight 2-3) — AO ownership areas ===

  - id: knowledge-flywheel-health
    description: "Knowledge flywheel has ≥5 learnings and newest is <30 days old"
    check: "test $(ls .agents/learnings/*.md 2>/dev/null | wc -l | tr -d ' ') -ge 5 && test $(find .agents/learnings/ -name '*.md' -mtime -30 2>/dev/null | head -1 | wc -l | tr -d ' ') -ge 1"
    weight: 3

  - id: skill-semantic-stability
    description: "Core skills have name, tier, and description in YAML frontmatter"
    check: "for s in council crank swarm rpi vibe pre-mortem post-mortem plan research implement evolve; do grep -q '^name:' skills/$s/SKILL.md && grep -q 'tier:' skills/$s/SKILL.md && grep -q '^description:' skills/$s/SKILL.md || exit 1; done"
    weight: 3

  - id: bridge-contract-schemas
    description: "Bridge contracts doc defines all 3 canonical surfaces (INVOCATION_ENVELOPE, STATE_CHECKPOINT_HANDOFF, OBSERVABILITY_EVENTS)"
    check: "grep -q 'INVOCATION_ENVELOPE' docs/ol-bridge-contracts.md && grep -q 'STATE_CHECKPOINT_HANDOFF' docs/ol-bridge-contracts.md && grep -q 'OBSERVABILITY_EVENTS' docs/ol-bridge-contracts.md"
    weight: 2

  - id: learning-format-compliance
    description: "Learnings conform to interchange spec (YAML frontmatter with id, type, created_at)"
    check: "for f in $(ls .agents/learnings/*.md | head -10); do head -10 \"$f\" | grep -q '^---' && head -10 \"$f\" | grep -q '^id:' && head -10 \"$f\" | grep -q '^type:' && head -10 \"$f\" | grep -q '^created_at:' || exit 1; done"
    weight: 2

  - id: council-schema-valid
    description: "Council verdict schema has additionalProperties:false at all levels and required covers core properties (v2 optional fields: fix, why, ref)"
    check: "jq -e '. as $s | ($s.additionalProperties == false) and (($s.required | length) == ($s.properties | keys | length)) and ($s.properties.findings.items.additionalProperties == false) and (($s.properties.findings.items.required | length) >= 5) and (($s.properties.findings.items.properties | keys | length) <= ($s.properties.findings.items.required | length) + 3)' skills/council/schemas/verdict.json >/dev/null 2>&1"
    weight: 2

  # === Hygiene (weight 1-2) — Docs & consistency ===

  - id: shellcheck-clean
    description: "Hook scripts pass shellcheck with no warnings"
    check: "shellcheck -x -P SCRIPTDIR hooks/*.sh 2>&1 | grep -c '^In ' | xargs test 0 -eq"
    weight: 2

  - id: go-coverage-floor
    description: "Go CLI average test coverage stays above 80%"
    check: "cd cli && go test -cover ./... 2>&1 | grep '^ok' | sed -n 's/.*coverage: \\([0-9.]*\\)%.*/\\1/p' | awk '{s+=$1;n++} END{if(n>0 && s/n>=80) exit 0; else exit 1}'"
    weight: 2

  - id: rpi-context-window-contract
    description: "RPI large-repo context sharding contract is healthy and runnable."
    check: "./scripts/rpi/context-window-contract.sh"
    weight: 2

  - id: doc-coverage
    description: "All public skills have references/ documentation"
    check: "test $(ls -d skills/*/references/ 2>/dev/null | wc -l | tr -d ' ') -ge 16"
    weight: 2

  - id: skill-tier-coverage
    description: "All skills have tier: defined in YAML frontmatter"
    check: "test $(grep -rl 'tier:' skills/*/SKILL.md 2>/dev/null | wc -l | tr -d ' ') -eq $(ls -d skills/*/ 2>/dev/null | wc -l | tr -d ' ')"
    weight: 2

  - id: skill-validation
    description: "All skills have valid SKILL.md with frontmatter"
    check: "./tests/skills/run-all.sh"
    weight: 2

  - id: orchestration-skills-validated
    description: "All orchestration-tier skills have validate.sh scripts"
    check: "for d in council crank swarm codex-team rpi evolve; do test -x skills/$d/scripts/validate.sh || exit 1; done"
    weight: 2

  - id: behavioral-skill-contracts
    description: "All 34 skills have behavioral validate.sh checks that pass"
    check: "for d in skills/*/scripts/validate.sh; do \"$d\" >/dev/null 2>&1 || exit 1; done"
    weight: 2

  - id: hook-tests-pass
    description: "All 100 hook integration tests pass"
    check: "bash tests/hooks/test-hooks.sh 2>&1 | tail -1 | grep -q 'ALL PASSED'"
    weight: 2

  - id: export-constraints-readiness
    description: "ao export-constraints subcommand is stubbed in CLI"
    check: "grep -rq 'export.constraints\\|export-constraints\\|exportConstraints' cli/cmd/ao/ 2>/dev/null"
    weight: 1

  - id: incident-runbook-exists
    description: "Consumer incident runbook exists with recovery procedures"
    check: "test -f docs/INCIDENT-RUNBOOK.md && grep -q 'AGENTOPS_HOOKS_DISABLED' docs/INCIDENT-RUNBOOK.md"
    weight: 1
