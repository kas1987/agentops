# Releasing AgentOps

This document describes the release process for the `ao` CLI and AgentOps plugin.

## Overview

Releases are triggered by git tags and follow a 4-stage pipeline:

```
git tag v2.3.0
    ↓
┌──────────────────────────────────────────────────────┐
│                release.yml workflow                  │
├──────────────────────────────────────────────────────┤
│  DOC GATE   → Runs tests/docs/validate-doc-release.sh│
│               Checks links, skill counts, and        │
│               release-message freeze                 │
├──────────────────────────────────────────────────────┤
│  BUILD      → GoReleaser builds 4 binaries           │
│               (darwin/linux × amd64/arm64)           │
│               Generates checksums.txt (SHA256)       │
│               Uploads as workflow artifacts           │
├──────────────────────────────────────────────────────┤
│  VALIDATE   → Downloads darwin-arm64 artifact        │
│               Runs scripts/validate-release.sh       │
│               Checks version, size, executability    │
├──────────────────────────────────────────────────────┤
│  PUBLISH    → Creates GitHub Release with notes      │
│               Uploads binaries + checksums           │
│               Pushes Homebrew formula                │
│               Generates SLSA provenance attestation  │
└──────────────────────────────────────────────────────┘
```

## Making a Release

### 1. Pre-release Checklist

- [ ] All tests pass locally (`cd cli && make test`)
- [ ] CI green on main (check Actions tab)
- [ ] Version number follows semver (vX.Y.Z)
- [ ] CHANGELOG.md updated with release notes
- [ ] plugin.json version matches tag
- [ ] No uncommitted changes on main
- [ ] Homebrew token is valid (check secrets)
- [ ] Doc-release gate passes locally (`./tests/docs/validate-doc-release.sh`)

### 2. Update CHANGELOG

Follow [Keep a Changelog](https://keepachangelog.com/) format:

```markdown
## [2.3.0] - 2026-02-10

### Added
- Feature description

### Changed
- Change description

### Fixed
- Fix description
```

### 3. Create and Push Tag

```bash
# Ensure you're on main and up to date
git checkout main
git pull

# Create annotated tag
git tag -a v2.3.0 -m "Release v2.3.0"

# Push tag (triggers release workflow)
git push origin v2.3.0
```

### 4. Monitor the Workflow

Watch the release at: https://github.com/boshu2/agentops/actions

The workflow runs four jobs sequentially:
1. **doc-release-gate** - Validates links, skill counts, and release-message freeze
2. **build** - Creates binaries + checksums (~2 min)
3. **validate** - Tests darwin-arm64 binary (~1 min)
4. **publish** - Creates release, updates Homebrew, signs attestation (~2 min)

### 5. Verify the Release

After the workflow completes:

```bash
# Update Homebrew
brew update

# Upgrade ao
brew upgrade agentops

# Verify version
ao version
# Should show: ao version 2.3.0
```

### 6. Verify Integrity (checksums + provenance)

```bash
# Download and verify checksums
curl -sL https://github.com/boshu2/agentops/releases/download/v2.3.0/checksums.txt
shasum -a 256 -c checksums.txt --ignore-missing

# Verify SLSA provenance (requires gh CLI)
gh attestation verify ao-darwin-arm64.tar.gz --repo boshu2/agentops
```

## Release Artifacts

Each release produces:

| Artifact | Description |
|----------|-------------|
| `ao-darwin-amd64.tar.gz` | macOS Intel binary |
| `ao-darwin-arm64.tar.gz` | macOS Apple Silicon binary |
| `ao-linux-amd64.tar.gz` | Linux x86_64 binary |
| `ao-linux-arm64.tar.gz` | Linux ARM64 binary |
| `checksums.txt` | SHA256 checksums for all archives |
| SLSA attestation | Build provenance (verifiable via `gh attestation verify`) |

## Release Notes

Release notes are auto-generated by GoReleaser with:
- **Header** with install/upgrade instructions and integrity verification
- **Changelog** grouped by type (features, fixes, docs, other)
- **Footer** with full changelog diff link

The template lives in `.goreleaser.yml` under `release.header` and `release.footer`.

## Validation Checks

The `validate` stage runs `scripts/validate-release.sh` which checks:

| Check | What it Catches |
|-------|-----------------|
| Binary exists | Build produced no output |
| Size > 1MB | Truncated or corrupted binary |
| File is executable | Wrong file type in archive |
| Version matches tag | ldflags injection failed |
| `--help` works | Binary crashes on startup |
| `-h` works | Flag parsing broken |
| `status` runs | Basic command execution |

## Doc-Release Stabilization Gate

The `doc-release-gate` stage runs `tests/docs/validate-doc-release.sh`, which is a single
gate for:

- Link validation (`tests/docs/validate-links.sh`)
- Skill count consistency (`tests/docs/validate-skill-count.sh`)
- Release message freeze check (against `.goreleaser.yml` release header/footer text)

### Message Freeze Override

By default, release message text is frozen. Any change to the canonical release header/footer
in `.goreleaser.yml` fails the gate.

To intentionally bypass this check, set both variables:

```bash
DOC_RELEASE_FREEZE_OVERRIDE=true
DOC_RELEASE_FREEZE_REASON="short explanation of approved copy change"
```

In GitHub Actions `workflow_dispatch`, these are exposed as inputs:

- `doc_release_freeze_override` (`true` or `false`)
- `doc_release_freeze_override_reason` (required when override is true)

## Failure Modes

### Validation Fails

If validation fails, the release is NOT published. The tag exists but no release was created.

**To fix:**
1. Identify the issue from the workflow logs
2. Fix the code
3. Delete the tag: `git tag -d v2.3.0 && git push origin :refs/tags/v2.3.0`
4. Create a new tag after fixing

### Publish Fails

If publish fails after validation passed, the release may be in a partial state.

**To fix:**
1. Check if GitHub release was created (may need manual cleanup)
2. Check if Homebrew formula was pushed
3. Use `workflow_dispatch` to re-run manually if needed

### Homebrew Token Expired

The `HOMEBREW_TAP_GITHUB_TOKEN` secret is validated before publish. If it fails:

1. Generate a new PAT at https://github.com/settings/tokens
2. Scope: `public_repo` (for homebrew-agentops)
3. Update the secret in repository settings

## Manual Release (workflow_dispatch)

If you need to re-run a release without pushing a new tag:

1. Go to Actions → Release workflow
2. Click "Run workflow"
3. Enter the tag (e.g., `v2.3.0`)
4. Optionally set `doc_release_freeze_override=true` and provide a reason
5. Click "Run workflow"

## Local Testing

Before tagging, you can test the build locally:

```bash
# Install goreleaser
brew install goreleaser

# Validate config
goreleaser check

# Build snapshot (doesn't require tag)
goreleaser build --snapshot --clean --single-target

# Test the binary
./dist/ao_darwin_arm64/ao version
./dist/ao_darwin_arm64/ao --help
./dist/ao_darwin_arm64/ao status

# Run doc-release gate
./tests/docs/validate-doc-release.sh
```

## Dependency Automation Policy

Dependency automation is managed by Dependabot and follows this policy:

- Scope: Go modules (`/cli/go.mod`) and GitHub Actions (`/.github/workflows/*.yml`)
- Cadence: Weekly on Monday (separate schedules for Go and Actions)
- Grouping: Minor and patch updates are grouped per ecosystem
- Major updates: Opened as separate PRs for explicit review
- Security updates: Treated as priority work and merged outside normal cadence when validated
- PR limits: Capped to keep queue manageable and avoid review overload

## Configuration Files

| File | Purpose |
|------|---------|
| `.goreleaser.yml` | Build config, checksums, release notes, Homebrew formula |
| `.github/workflows/release.yml` | 4-stage release workflow (doc gate → build → validate → publish) |
| `.github/workflows/validate.yml` | CI validation (includes doc-release stabilization gate) |
| `.github/workflows/nightly.yml` | Nightly tests with failure alerts |
| `.github/dependabot.yml` | Dependabot policy and schedules for Go modules + GitHub Actions |
| `scripts/validate-release.sh` | Binary validation script |
| `tests/docs/validate-doc-release.sh` | Unified doc-release gate (links + skills + message freeze) |

## Homebrew Tap

The Homebrew formula is automatically pushed to:
https://github.com/boshu2/homebrew-agentops

Users install with:
```bash
brew tap boshu2/agentops
brew install agentops
```

## Security

- **Checksums:** SHA256 checksums for all archives (`checksums.txt`)
- **SLSA provenance:** Build attestation via `actions/attest-build-provenance`
- **Dependabot:** Automated dependency updates for Go modules and GitHub Actions
- **Security scan:** Secrets and dangerous pattern detection on every PR

See [SECURITY.md](../SECURITY.md) for vulnerability reporting.

## Troubleshooting

### "ao version" shows "dev"

The ldflags version injection failed. Check `.goreleaser.yml`:
```yaml
ldflags:
  - -s -w -X main.version={{ .Version }}
```

The validation stage should catch this before publish.

### Binary not found in tarball

GoReleaser archive naming doesn't match extraction pattern. Check:
- `.goreleaser.yml` `archives` section
- Workflow's `find` command for tarball

### Homebrew formula not updated

1. Check `HOMEBREW_TAP_GITHUB_TOKEN` is valid
2. Check workflow logs for push errors
3. Verify formula at homebrew-agentops repo

### Attestation verification fails

```bash
# Ensure gh CLI is authenticated
gh auth status

# Try verification with verbose output
gh attestation verify <file> --repo boshu2/agentops --verbose
```
